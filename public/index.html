<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <title>–†–æ–¥–Ω—è - –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</title>
    <link rel="stylesheet" href="style.css?v=15.2">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4facfe">
    <meta name="description" content="–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –±–ª–∏–∑–∫–∏–º–∏. –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏, —Å–æ–æ–±—â–µ–Ω–∏—è, –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–†–æ–¥–Ω—è">
    <meta name="msapplication-TileColor" content="#4facfe">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üë•</text></svg>">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-container">
            <div class="auth-header">
                <i class="fas fa-users"></i>
                <h1>–†–æ–¥–Ω—è</h1>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <div class="auth-form" id="login-form">
                <h2>–í—Ö–æ–¥</h2>
                <input type="text" id="login-username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" maxlength="20">
                <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" maxlength="20">
                <button class="auth-btn" id="login-btn">–í–æ–π—Ç–∏</button>
                <p class="auth-toggle">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="toggleAuthForm()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div class="auth-form" id="register-form" style="display: none;">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <input type="text" id="register-username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" maxlength="20">
                <input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å" maxlength="20">
                <input type="password" id="register-password-confirm" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" maxlength="20">
                <button class="auth-btn" id="register-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <p class="auth-toggle">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="toggleAuthForm()">–í–æ–π—Ç–∏</a></p>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="container" id="main-container" style="display: none;">
        <header class="header">
            <div class="logo">
                <i class="fas fa-users"></i>
                <h1>–†–æ–¥–Ω—è</h1>
            </div>
            <button class="toggle-sidebar-btn" id="toggle-sidebar-btn" title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏">
                <i class="fas fa-users"></i>
            </button>
            <div class="user-info">
                <span class="current-user" id="current-user"></span>
                <span class="online-count">–û–Ω–ª–∞–π–Ω: <span id="online-count">0</span></span>
                <button class="profile-btn" id="profile-btn" title="–ü—Ä–æ—Ñ–∏–ª—å">
                    <i class="fas fa-user-circle"></i>
                </button>
                <button class="logout-btn" id="logout-btn" title="–í—ã—Ö–æ–¥">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- –ë–∞–Ω–Ω–µ—Ä –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="notification-permission-banner" id="notification-permission-banner" style="display: none;">
            <div class="banner-content">
                <span>–í–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</span>
                <div class="banner-buttons">
                    <button class="banner-btn allow" id="allow-notifications-btn">–í–∫–ª—é—á–∏—Ç—å</button>
                    <button class="banner-btn dismiss" id="dismiss-notifications-btn">–ü–æ–∑–∂–µ</button>
                </div>
            </div>
        </div>

        <main class="main-content">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                </div>
                <div class="users-list" id="users-list">
                    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                </div>
            </aside>

            <div class="chat-container">
                <div class="chat-header" id="chat-header">
                    <button class="back-to-general-btn" id="back-to-general-btn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> –û–±—â–∏–π —á–∞—Ç
                    </button>
                    <div class="chat-header-info">
                        <img id="chat-user-avatar" class="chat-user-avatar" src="" alt="Avatar" style="display: none;">
                        <div class="chat-header-text">
                            <h2 id="chat-title">–û–±—â–∏–π —á–∞—Ç</h2>
                            <span id="chat-user-status" class="chat-user-status"></span>
                        </div>
                    </div>
                    <button class="chat-call-btn" id="chat-call-btn" style="display: none;" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">
                        <i class="fas fa-phone"></i>
                    </button>
                </div>

                <div class="messages" id="messages">
                    <div class="welcome-message">
                        <i class="fas fa-heart"></i>
                        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –†–æ–¥–Ω—é!</h2>
                        <p>–û–±—â–∞–π—Ç–µ—Å—å —Å –±–ª–∏–∑–∫–∏–º–∏, –¥–µ–ª–∏—Ç–µ—Å—å –º–æ–º–µ–Ω—Ç–∞–º–∏ –∂–∏–∑–Ω–∏</p>
                    </div>
                </div>
                
                <div class="message-input-container">
                    <!-- –°–∫—Ä—ã—Ç—ã–µ input —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤ -->
                    <input type="file" id="file-input" accept="image/*,video/*,audio/*" style="display: none;">
                    <input type="file" id="photo-input" accept="image/*" style="display: none;">
                    <input type="file" id="video-input" accept="video/*" style="display: none;">
                    <input type="file" id="doc-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar" style="display: none;">
                    
                    <div class="file-upload-area" id="file-upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</span>
                    </div>

                    <div class="image-preview-modal" id="image-preview-modal">
                        <div class="preview-content">
                            <button class="close-preview" id="close-preview">&times;</button>
                            <div class="preview-image-container">
                                <img id="preview-image" src="" alt="Preview">
                            </div>
                            <div class="preview-controls">
                                <input type="text" id="image-caption" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å..." maxlength="200">
                                <button class="preview-btn cancel" id="cancel-preview">–û—Ç–º–µ–Ω–∞</button>
                                <button class="preview-btn send" id="send-preview">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ú–æ–¥–∞–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π -->
                    <div class="video-viewer-modal" id="video-viewer-modal">
                        <div class="video-viewer-content">
                            <button class="close-video-viewer" id="close-video-viewer">&times;</button>
                            <video id="viewer-video" class="viewer-video-player"></video>
                            <div class="video-controls-overlay">
                                <button class="video-play-btn" id="video-play-btn">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="image-viewer-modal" id="image-viewer-modal">
                        <div class="image-viewer-content">
                            <button class="close-viewer" id="close-viewer">&times;</button>
                            <img id="viewer-image" src="" alt="Image">
                            <button class="fullscreen-viewer-btn" id="fullscreen-viewer-btn" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç–∏–Ω–æ–∫ -->
                    <div class="fullscreen-image-modal" id="fullscreen-image-modal">
                        <button class="close-fullscreen" id="close-fullscreen">&times;</button>
                        <div class="fullscreen-controls">
                            <button class="zoom-btn" id="zoom-out-btn" title="–û—Ç–¥–∞–ª–∏—Ç—å">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="zoom-level" id="zoom-level">100%</span>
                            <button class="zoom-btn" id="zoom-in-btn" title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="fullscreen-image-container" id="fullscreen-image-container">
                            <img id="fullscreen-image" src="" alt="Image">
                        </div>
                    </div>
                    
                    <div class="typing-indicator" id="typing-indicator" style="display: none;">
                        <span id="typing-user-name"></span> –ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
                    </div>
                    
                    <div class="input-area">
                        <div class="input-controls">
                            <button class="control-btn" id="attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <div class="attach-menu" id="attach-menu">
                                <button class="attach-option" id="photo-btn" title="–§–æ—Ç–æ">
                                    <i class="fas fa-image"></i> –§–æ—Ç–æ
                                </button>
                                <button class="attach-option" id="video-btn" title="–í–∏–¥–µ–æ">
                                    <i class="fas fa-video"></i> –í–∏–¥–µ–æ
                                </button>
                                <button class="attach-option" id="file-btn" title="–î–æ–∫—É–º–µ–Ω—Ç">
                                    <i class="fas fa-file"></i> –î–æ–∫—É–º–µ–Ω—Ç
                                </button>
                            </div>
                            <button class="control-btn" id="emoji-btn" title="–≠–º–æ–¥–∑–∏">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="control-btn" id="voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        
                        <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
                        
                        <button class="send-btn" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="emoji-picker" id="emoji-picker">
        <div class="emoji-grid">
            <span class="emoji">üòÄ</span><span class="emoji">üòÇ</span><span class="emoji">üòç</span><span class="emoji">ü•∞</span>
            <span class="emoji">üòä</span><span class="emoji">üòé</span><span class="emoji">ü§î</span><span class="emoji">üò¢</span>
            <span class="emoji">üò≠</span><span class="emoji">üò°</span><span class="emoji">üëç</span><span class="emoji">üëé</span>
            <span class="emoji">‚ù§Ô∏è</span><span class="emoji">üíï</span><span class="emoji">üî•</span><span class="emoji">‚ú®</span>
            <span class="emoji">üéâ</span><span class="emoji">üéä</span><span class="emoji">üíØ</span><span class="emoji">üëè</span>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏ -->
    <div class="avatar-editor-modal" id="avatar-editor-modal">
        <div class="avatar-editor-content">
            <button class="close-editor" id="close-editor">&times;</button>
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É</h3>
            <div class="avatar-editor-container">
                <canvas id="avatar-canvas"></canvas>
                <div class="avatar-controls">
                    <input type="range" id="zoom-slider" min="0.5" max="3" step="0.1" value="1">
                    <span id="zoom-value">100%</span>
                </div>
            </div>
            <div class="avatar-editor-buttons">
                <button class="btn-cancel" id="cancel-editor">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-save" id="save-editor">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div class="profile-modal" id="profile-modal">
        <div class="profile-content">
            <button class="close-profile" id="close-profile">&times;</button>
            <div class="profile-header">
                <img id="profile-avatar" src="" alt="Avatar" class="profile-avatar">
                <button class="change-avatar-btn" id="change-avatar-btn">–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
                <input type="file" id="avatar-input" accept="image/*" style="display: none;">
            </div>
            <div class="profile-form">
                <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="profile-username" maxlength="20">
                
                <label>–°—Ç–∞—Ç—É—Å:</label>
                <input type="text" id="profile-status" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å..." maxlength="100">
                
                <label>–¢–µ–º–∞:</label>
                <div class="theme-toggle">
                    <button class="theme-btn" id="light-theme-btn">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
                    <button class="theme-btn active" id="dark-theme-btn">üåô –¢—ë–º–Ω–∞—è</button>
                </div>
                
                <button class="profile-save-btn" id="profile-save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ -->
    <div class="incoming-call-modal" id="incoming-call-modal">
        <div class="incoming-call-content">
            <div class="incoming-call-header">
                <i class="fas fa-phone-alt"></i>
                <h2>–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h2>
            </div>
            <div class="incoming-call-info">
                <span id="incoming-caller-name" class="caller-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                <span class="call-status">–ó–≤–æ–Ω–∏—Ç...</span>
            </div>
            <div class="incoming-call-buttons">
                <button class="call-btn reject" id="reject-call-btn">
                    <i class="fas fa-phone-slash"></i>
                </button>
                <button class="call-btn accept" id="accept-call-btn">
                    <i class="fas fa-phone"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ -->
    <div class="active-call-modal" id="active-call-modal">
        <div class="active-call-content">
            <div class="active-call-header">
                <span id="active-call-user" class="call-user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                <span id="call-duration" class="call-duration">00:00</span>
            </div>
            <div class="active-call-video-container" id="active-call-video-container">
                <video id="local-video" autoplay muted playsinline></video>
                <video id="remote-video" autoplay playsinline></video>
            </div>
            <div class="active-call-controls">
                <button class="call-control-btn" id="toggle-audio-btn" title="–û—Ç–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="call-control-btn" id="toggle-video-btn" title="–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É">
                    <i class="fas fa-video"></i>
                </button>
                <button class="call-control-btn" id="toggle-screen-btn" title="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞">
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="call-control-btn end-call" id="end-call-btn" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="script.js?v=15.2"></script>
    <script>
        // PWA Installation
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then((registration) => {
                        console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
                        setInterval(() => {
                            registration.update();
                        }, 6 * 60 * 60 * 1000);
                    })
                    .catch((error) => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
                    });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Service Worker
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('üîÑ Service Worker –æ–±–Ω–æ–≤–ª—ë–Ω');
                    window.location.reload();
                });
            });
        }
        
        // –ó–∞–ø—Ä–æ—Å –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('üì± PWA –≥–æ—Ç–æ–≤–∞ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ');
            
            // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            // showInstallButton();
        });
        
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            deferredPrompt = null;
        });
    </script>
</body>
</html>